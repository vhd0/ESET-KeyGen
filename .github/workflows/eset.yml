name: Automated Account and Key Generator

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      account:
        description: 'S·ªë l∆∞·ª£ng t√†i kho·∫£n c·∫ßn t·∫°o (m·∫∑c ƒë·ªãnh = 0)'
        required: false
        default: '0'
        type: string
      key:
        description: 'S·ªë l∆∞·ª£ng kh√≥a c·∫ßn t·∫°o (m·∫∑c ƒë·ªãnh = 1)'
        required: false
        default: '1'
        type: string
      branch:
        description: "Nh√°nh kho l∆∞u tr·ªØ"
        required: false
        type: choice
        options:
          - main
          - test
        default: main

jobs:
  generate-account-and-key:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Ki·ªÉm tra kho l∆∞u tr·ªØ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng Python
        run: |
          sudo apt update
          sudo apt install -y python3-pip python3-venv

      - name: T·∫°o Swap File (tr√°nh l·ªói h·∫øt RAM)
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Th·ª≠ t·ªï h·ª£p t·∫°o t√†i kho·∫£n & key
        shell: bash
        env:
          ACCOUNT: ${{ github.event.inputs.account || '0' }}
          KEY: ${{ github.event.inputs.key || '1' }}
        run: |
          git clone -b ${{ github.event.inputs.branch || 'main' }} https://github.com/rzc0d3r/ESET-KeyGen.git
          cd ESET-KeyGen
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

          MAIL_PROVIDERS=("1secmail" "guerrillamail" "developermail" "mailticking" "fakemail" "inboxes" "incognitomail" "emailfake")
          KEY_TYPES=("--key" "--small-business-key")
          OS_LIST=("Linux" "Windows" "macOS")

          SHUFFLED_MAILS=($(printf "%s\n" "${MAIL_PROVIDERS[@]}" | shuf))
          SHUFFLED_KEYS=($(printf "%s\n" "${KEY_TYPES[@]}" | shuf))
          SHUFFLED_OS=($(printf "%s\n" "${OS_LIST[@]}" | shuf))

          SUCCESS=0
          touch output.log

          run_with_timeout() {
            local timeout_duration=90
            local command=("$@")
            "${command[@]}" & pid=$!
            for ((i=1; i<=timeout_duration; i++)); do
              if ! kill -0 $pid 2>/dev/null; then
                wait $pid
                return $?
              fi
              sleep 1
            done
            kill -9 $pid 2>/dev/null
            wait $pid 2>/dev/null
            echo "‚ö†Ô∏è Timeout sau ${timeout_duration}s"
            return 124
          }

          for CURRENT_OS in "${SHUFFLED_OS[@]}"; do
            export CURRENT_OS
            for MAIL in "${SHUFFLED_MAILS[@]}"; do
              for KEY_TYPE in "${SHUFFLED_KEYS[@]}"; do
                echo "Th·ª≠ OS=$CURRENT_OS, Mail=$MAIL, Key Type=$KEY_TYPE"
                rm -f *KEYS.txt *ACCOUNTS.txt

                if [[ "$ACCOUNT" != "0" ]]; then
                  run_with_timeout python3 main.py --auto-detect-browser --account --email-api "$MAIL" \
                    --skip-update-check --no-logo --disable-progress-bar --disable-logging \
                    --repeat "$ACCOUNT" | tee -a output.log
                fi

                if [[ "$KEY" != "0" ]]; then
                  run_with_timeout python3 main.py --auto-detect-browser "$KEY_TYPE" --email-api "$MAIL" \
                    --skip-update-check --no-logo --disable-progress-bar --disable-logging \
                    --repeat "$KEY" | tee -a output.log

                  if grep -q "License Key:" output.log && \
                     grep -q "Account Email:" output.log && \
                     grep -q "Account Password:" output.log && \
                     grep -q "License Out Date:" output.log && \
                     grep -q "License Name:" output.log; then
                    echo "‚úÖ Th√†nh c√¥ng v·ªõi OS=$CURRENT_OS"
                    SUCCESS=1
                    break 3
                  else
                    echo "‚ùå Th·ª≠ th·∫•t b·∫°i, th·ª≠ t·ªï h·ª£p ti·∫øp theo"
                  fi
                elif [[ "$ACCOUNT" != "0" ]]; then
                  echo "‚úÖ T·∫°o t√†i kho·∫£n OK, kh√¥ng t·∫°o key. D·ª´ng th·ª≠"
                  SUCCESS=1
                  break 3
                fi
              done
            done
          done

          if [[ $SUCCESS -eq 0 ]]; then
            echo "‚ùå Th·ª≠ h·∫øt t·ªï h·ª£p v·∫´n kh√¥ng th√†nh c√¥ng"
            exit 1
          fi

      - name: C·∫≠p nh·∫≠t b·∫£ng Markdown v·ªõi Python
        if: success()
        working-directory: ./ESET-KeyGen
        shell: bash
        run: |
          python3 update_markdown.py output.log

      - name: Commit & Push k·∫øt qu·∫£
        if: success()
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -f "ESET-KeyGen/generated_results.md" ]; then
            cp ESET-KeyGen/generated_results.md .
            git add generated_results.md
            if ! git diff --cached --quiet; then
              git commit -m "üîÑ C·∫≠p nh·∫≠t k·∫øt qu·∫£ t·ª± ƒë·ªông [skip ci]"
              git push origin HEAD:${{ github.event.inputs.branch || 'main' }}
            else
              echo "Kh√¥ng c√≥ thay ƒë·ªïi ƒë·ªÉ push."
            fi
          else
            echo "‚ùó Kh√¥ng t√¨m th·∫•y t·ªáp generated_results.md"
          fi
