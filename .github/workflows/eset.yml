name: Automated Account and Key Generator

on:
  schedule:
    - cron: "0 0 * * *" # Chạy tự động vào lúc 00:00 UTC mỗi ngày
  workflow_dispatch:
    inputs:
      account:
        description: 'Số lượng tài khoản cần tạo (mặc định = 0)'
        required: false
        default: '0'
        type: string
      key:
        description: 'Số lượng khóa cần tạo (mặc định = 1)'
        required: false
        default: '1'
        type: string
      branch:
        description: "Nhánh kho lưu trữ (không chạm vào nếu bạn không biết gì về nó!!!)"
        required: false
        type: choice
        options:
          - main
          - test
        default: main

jobs:
  generate-account-and-key:
    runs-on: ubuntu-latest # Chạy trên môi trường Ubuntu mới nhất
    permissions:
      contents: write # Cấp quyền ghi vào kho lưu trữ để cập nhật file Markdown
    steps:
      - name: Kiểm tra kho lưu trữ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Thiết lập môi trường và tạo Swap File
        run: |
          echo "Cài đặt các gói cần thiết..."
          sudo apt update
          sudo apt install -y python3-pip python3-venv

          echo "Tạo swap file 8G để tránh lỗi hết bộ nhớ..."
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap file đã được tạo và kích hoạt."

      - name: Thử tất cả tổ hợp cho đến khi thành công
        shell: bash
        env:
          ACCOUNT: ${{ github.event.inputs.account || '0' }}
          KEY: ${{ github.event.inputs.key || '1' }}
        run: |
          # Tạo và kích hoạt môi trường ảo Python
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

          # Định nghĩa tất cả tổ hợp có thể của nhà cung cấp mail, loại key và hệ điều hành
          MAIL_PROVIDERS=("1secmail" "guerrillamail" "developermail" "mailticking" "fakemail" "inboxes" "incognitomail" "emailfake")
          KEY_TYPES=("--key" "--small-business-key")
          OS_LIST=("Linux" "Windows" "macOS")
          
          # Ngẫu nhiên hóa thứ tự các tổ hợp để thử
          SHUFFLED_MAILS=($(printf "%s\n" "${MAIL_PROVIDERS[@]}" | shuf))
          SHUFFLED_KEYS=($(printf "%s\n" "${KEY_TYPES[@]}" | shuf))
          SHUFFLED_OS=($(printf "%s\n" "${OS_LIST[@]}" | shuf))

          SUCCESS=0
          echo "Bắt đầu thử các tổ hợp ngẫu nhiên..."

          # Function để chạy command với timeout, tránh việc script bị treo
          run_with_timeout() {
            local timeout_duration=90
            local command=("$@")
            "${command[@]}" & pid=$!
            
            for ((i=1; i<=timeout_duration; i++)); do
              if ! kill -0 $pid 2>/dev/null; then
                wait $pid
                return $?
              fi
              sleep 1
            done
            
            kill -9 $pid 2>/dev/null
            wait $pid 2>/dev/null
            echo "Process timed out after ${timeout_duration}s"
            return 124
          }

          # Thử từng tổ hợp cho đến khi thành công
          for CURRENT_OS in "${SHUFFLED_OS[@]}"; do
            export CURRENT_OS
            echo "=== Thử với OS: $CURRENT_OS ==="
            
            for MAIL in "${SHUFFLED_MAILS[@]}"; do
              for KEY_TYPE in "${SHUFFLED_KEYS[@]}"; do
                echo "=== Thử tổ hợp: OS=$CURRENT_OS, Mail=$MAIL, Key Type=$KEY_TYPE ==="
                
                rm -f output.log *KEYS.txt *ACCOUNTS.txt

                if [[ "$ACCOUNT" != "0" ]]; then
                  echo "Tạo $ACCOUNT tài khoản với $MAIL..."
                  run_with_timeout python3 main.py --auto-detect-browser --account --email-api "$MAIL" \
                    --skip-update-check --no-logo --disable-progress-bar --disable-logging \
                    --repeat "$ACCOUNT" | tee -a output.log
                fi
                
                if [[ "$KEY" != "0" ]]; then
                  echo "Tạo $KEY khóa với $MAIL và $KEY_TYPE..."
                  run_with_timeout python3 main.py --auto-detect-browser "$KEY_TYPE" --email-api "$MAIL" \
                    --skip-update-check --no-logo --disable-progress-bar --disable-logging \
                    --repeat "$KEY" | tee -a output.log

                  if grep -q "License Key:" output.log && \
                      grep -q "Account Email:" output.log && \
                      grep -q "Account Password:" output.log && \
                      grep -q "License Out Date:" output.log && \
                      grep -q "License Name:" output.log; then
                    echo "✅ Tạo khóa thành công với OS=$CURRENT_OS!"
                    SUCCESS=1
                    break 3
                  else
                    echo "❌ Không thể tạo khóa với tổ hợp này hoặc thông tin bị thiếu, thử tổ hợp tiếp theo..."
                  fi
                else
                  if [[ "$ACCOUNT" != "0" ]]; then
                    echo "Chỉ tạo tài khoản, không tạo khóa. Coi là thành công."
                    SUCCESS=1
                    break 3
                  fi
                fi
              done
            done
          done

          if [[ $SUCCESS -eq 0 ]]; then
            echo "❌ Đã thử tất cả tổ hợp nhưng không thành công!"
            exit 1
          fi

      - name: Cập nhật bảng Markdown trực tiếp
        if: success()
        shell: bash
        run: |
          RESULTS_FILE="results.md"

          # Tạo file Markdown nếu chưa tồn tại
          if [ ! -f "$RESULTS_FILE" ]; then
            echo "# ESET License Keys" > "$RESULTS_FILE"
            echo "" >> "$RESULTS_FILE"
            echo "| Email | Password | License Name | License Key | Expiry |" >> "$RESULTS_FILE"
            echo "|---|---|---|---|---|" >> "$RESULTS_FILE"
          fi

          # Trích xuất dữ liệu từ output.log
          ACCOUNT_EMAIL=$(grep "Account Email:" output.log | cut -d ':' -f 2- | sed 's/^[[:space:]]*//')
          # Thoát ký tự backtick trong mật khẩu trước khi bọc nó trong dấu backtick
          ACCOUNT_PASSWORD=$(grep "Account Password:" output.log | cut -d ':' -f 2- | sed 's/^[[:space:]]*//' | sed 's/`/\\`/g')
          LICENSE_NAME=$(grep "License Name:" output.log | cut -d ':' -f 2- | sed 's/^[[:space:]]*//')
          LICENSE_KEY=$(grep "License Key:" output.log | cut -d ':' -f 2- | sed 's/^[[:space:]]*//')
          OUT_DATE=$(grep "License Out Date:" output.log | cut -d ':' -f 2- | sed 's/^[[:space:]]*//')

          # Tạo hàng mới cho bảng Markdown với đúng thứ tự cột
          NEW_ROW="| ${ACCOUNT_EMAIL} | \`${ACCOUNT_PASSWORD}\` | ${LICENSE_NAME} | ${LICENSE_KEY} | ${OUT_DATE} |"

          # Thêm hàng mới vào file Markdown
          echo "$NEW_ROW" >> "$RESULTS_FILE"
          echo "✅ Đã cập nhật file Markdown thành công."

      - name: Cập nhật và đẩy kết quả
        if: success()
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f "results.md" ]; then
            git add results.md
            if ! git diff --cached --quiet; then
              git commit -m "Cập nhật kết quả mới [skip ci]"
              git push origin HEAD:${{ github.event.inputs.branch || 'main' }}
            else
              echo "Không có thay đổi để commit/push."
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
